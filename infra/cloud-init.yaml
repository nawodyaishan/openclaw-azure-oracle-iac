#cloud-config
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - software-properties-common
  - git
  - openssl

runcmd:
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Add azureuser to docker group
  - usermod -aG docker azureuser

  # Clone OpenClaw
  - mkdir -p /opt/openclaw
  - git clone https://github.com/openclaw/openclaw.git /opt/openclaw

  # Create required directories
  - mkdir -p /opt/.openclaw
  - mkdir -p /opt/.openclaw/workspace

  # Set ownership to the container user (uid 1000):
  - chown -R 1000:1000 /opt/.openclaw
  - chown -R 1000:1000 /opt/.openclaw/workspace

  # Generate gateway token
  - export GATEWAY_TOKEN=$(openssl rand -hex 32)

  # Create .env file with required variables
  - |
    cat > /opt/openclaw/.env << EOF
    # OpenClaw Configuration
    # Generated by cloud-init on $(date)

    OPENCLAW_IMAGE=openclaw:latest
    
    # Directory paths (required for volume mounts)
    OPENCLAW_CONFIG_DIR=/opt/.openclaw/config
    OPENCLAW_WORKSPACE_DIR=/opt/.openclaw/workspace
    OPENCLAW_GATEWAY_BIND=lan
    OPENCLAW_GATEWAY_PORT=18789

    # Gateway token (auto-generated)
    OPENCLAW_GATEWAY_TOKEN=$(openssl rand -hex 32)
    XDG_CONFIG_HOME=/home/node/.openclaw

    # Claude API Keys - CONFIGURE THESE MANUALLY
    # SSH into the VM and edit this file: nano /opt/openclaw/.env
    CLAUDE_AI_SESSION_KEY=
    CLAUDE_WEB_SESSION_KEY=
    CLAUDE_WEB_COOKIE=
    EOF

  # Build OpenClaw images (required - no pre-built images exist)
  - cd /opt/openclaw && docker build -t openclaw:local -f Dockerfile .

  # Start OpenClaw gateway
  - cd /opt/openclaw && docker compose up -d openclaw-gateway

final_message: "OpenClaw setup complete after $UPTIME seconds"